# Cardano Testnet Deployment Guide

Complete guide for deploying biometric DIDs to the Cardano testnet (preprod network). This validates the entire transaction builder implementation with real blockchain interaction.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Step-by-Step Guide](#step-by-step-guide)
- [Verification](#verification)
- [Troubleshooting](#troubleshooting)
- [Cost Analysis](#cost-analysis)
- [Open-Source Compliance](#open-source-compliance)

## Prerequisites

### 1. Koios Endpoint Access (Public)

The deployment script queries the blockchain through the public Koios REST API. No API key is required.

1. Default endpoint: https://api.koios.rest/api/v1
2. Ensure outbound HTTPS access to the endpoint from your machine
3. (Optional) For air-gapped or high availability environments, point `--koios-base-url` to a self-hosted Koios instance

**Koios Characteristics:**
- Public REST API maintained by the Cardano community
- Supports metadata scanning and UTXO queries used by the script
- Open-source and self-hostable (see https://github.com/Koios-io/koios-artifacts)
- Anonymous usage; consider rate limits when running large batches

### 2. Testnet ADA (Free)

Request testnet ADA from the Cardano faucet:

1. Visit the [Cardano Testnet Faucet](https://docs.cardano.org/cardano-testnet/tools/faucet/)
2. Select "Preprod" network
3. Enter your testnet address (generated by script)
4. Complete CAPTCHA
5. Receive 1000 tADA (testnet ADA)
6. Wait 1-2 minutes for confirmation

**Important:** Testnet ADA has no real value. It's only for testing.

### 3. Python Environment

Ensure you have Python 3.9+ and required dependencies:

```bash
# Install dependencies
pip install -r requirements.txt

# Verify installation
python3 -c "from pycardano import Network; print('PyCardano OK')"
```

## Quick Start

### 1. (Optional) Configure Custom Koios Endpoint

```bash
# Default public endpoint requires no configuration
# Override if using a self-hosted Koios instance
python3 scripts/deploy_testnet.py --koios-base-url https://your-koios/api/v1
```

### 2. Generate Keys and Get Address

```bash
python3 scripts/deploy_testnet.py --dry-run
```

This will:
- Generate payment keys in `testnet-keys/`
- Show your testnet address
- Validate transaction (without submitting)

Example output:
```
üìç Address: addr_test1qz4x2y3a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
```

### 3. Get Testnet ADA

Visit faucet with your address:
```
https://docs.cardano.org/cardano-testnet/tools/faucet/
```

Paste your address and request tADA.

### 4. Deploy to Testnet

```bash
python3 scripts/deploy_testnet.py
```

This will:
- Build sample biometric DID
- Create transaction with CIP-20 metadata
- Submit to testnet
- Wait for confirmation
- Verify metadata on-chain
- Save deployment report

## Step-by-Step Guide

### Step 1: Generate Payment Keys

The deployment script generates Ed25519 payment keys:

```bash
python3 scripts/deploy_testnet.py --dry-run
```

**Files created in `testnet-keys/`:**
- `payment.skey` - Signing key (KEEP PRIVATE!)
- `payment.vkey` - Verification key (public)
- `payment.addr` - Testnet address

**Security Note:** These are test keys. Never use testnet keys on mainnet!

**Key Format:**
Keys are compatible with `cardano-cli` and can be imported to wallets.

### Step 2: Fund Your Address

1. Copy your address from script output
2. Visit https://docs.cardano.org/cardano-testnet/tools/faucet/
3. Select "Preprod" network
4. Paste address and request tADA
5. Wait for confirmation (1-2 minutes)

**Faucet Limits:**
- 1000 tADA per request
- 1 request per 24 hours per address
- Completely free (no registration)

### Step 3: Verify Balance

Check your UTXOs:

```bash
python3 scripts/deploy_testnet.py --dry-run
```

Expected output:
```
‚úÖ Found 1 UTXO(s)
üí∞ Total balance: 1000.000000 ADA (1000000000 lovelace)
   UTXO 1: 1,000,000,000 lovelace
```

### Step 4: Deploy Sample DID

Deploy with real transaction:

```bash
python3 scripts/deploy_testnet.py
```

**Deployment Process:**

1. **Key Loading** - Load signing key from `testnet-keys/`
2. **UTXO Query** - Fetch UTXOs from Koios
3. **DID Creation** - Generate sample 4-finger biometric DID
4. **Dry-Run** - Validate transaction and estimate fees
5. **Transaction Build** - Create signed transaction with metadata
6. **Submission** - Submit CBOR transaction to testnet
7. **Confirmation** - Wait for blockchain confirmation (20-40s)
8. **Verification** - Verify metadata on-chain

### Step 5: Check Transaction on Explorer

View your transaction on Cardanoscan:

```
https://preprod.cardanoscan.io/transaction/YOUR_TX_HASH
```

**What to Check:**
- ‚úÖ Transaction confirmed
- ‚úÖ Metadata tab shows label 674
- ‚úÖ Metadata contains DID document
- ‚úÖ Fee matches estimate
- ‚úÖ Inputs and outputs correct

### Step 6: Verify Metadata

The script automatically verifies CIP-20 metadata:

```
‚úÖ Metadata found on-chain!
   Label: 674 (CIP-20 biometric DID)
   DID: did:cardano:testnet:sample123
   Verification methods: 4
```

**Metadata Structure:**
```json
{
  "674": {
    "did": "did:cardano:testnet:sample123",
    "verificationMethod": [...],
    "authentication": [...],
    "created": "2025-10-14T00:00:00Z",
    "storage": "inline"
  }
}
```

### Step 7: Review Deployment Report

Check detailed report in `testnet-reports/`:

```bash
cat testnet-reports/testnet-deployment-TIMESTAMP.json
```

**Report Contents:**
- Transaction hash
- Block height and slot
- Fee paid (ADA and lovelace)
- Transaction size and metadata size
- DID document
- UTXO details
- Confirmation status
- Metadata verification

## Verification

### Manual Verification Checklist

1. **Transaction Confirmed:**
   ```bash
   # Check on explorer
   https://preprod.cardanoscan.io/transaction/TX_HASH
   ```

2. **Metadata Present:**
   - Click "Metadata" tab on explorer
   - Verify label 674 exists
   - Verify DID document structure

3. **Fee Reasonable:**
   - Typical fee: 0.17-0.25 ADA
   - Formula: 155381 + 44 √ó size (lovelace)
   - Check report for actual fee

4. **UTXO Consumed:**
   - Input UTXO marked as spent
   - Change UTXO created at same address

5. **Metadata Valid:**
   - CBOR encoded correctly
   - W3C DID document format
   - CIP-20 label 674

### Automated Verification

The script performs automatic verification:

```python
from decentralized_did.cardano.koios_client import KoiosClient
from decentralized_did.cardano.cache import TTLCache

client = KoiosClient(
   base_url="https://api.koios.rest/api/v1",
   cache=TTLCache(default_ttl=60)
)

# Check transaction status
status = await client.get_transaction_status(tx_hash)
assert status.confirmed

# Verify metadata
records = await client.get_transaction_metadata(tx_hash)
metadata = next((item["json_metadata"] for item in records if item["label"] == "674"), None)
assert metadata is not None
assert "did" in metadata
assert "verificationMethod" in metadata
```

## Troubleshooting

### Error: "No UTXOs found at this address"

**Cause:** Address not funded yet.

**Solution:**
1. Visit faucet: https://docs.cardano.org/cardano-testnet/tools/faucet/
2. Request tADA for your address
3. Wait 1-2 minutes for confirmation
4. Re-run script

### Error: "Insufficient funds"

**Cause:** Not enough tADA for transaction fee.

**Solution:**
- Minimum required: ~2-3 ADA
- Request more from faucet (if 24h limit passed)
- Or wait 24 hours and request again

### Error: "Koios request failed"

**Cause:** Network connectivity issue or Koios endpoint unavailable.

**Solution:**
- Check internet access to `https://api.koios.rest/api/v1`
- Retry after a short delay (script retries with exponential backoff)
- If using a self-hosted Koios instance, confirm the service is running and the URL is correct

### Error: "Koios rate limit exceeded"

**Cause:** Too many API requests in a short window against a shared endpoint.

**Solution:**
- The script automatically retries with backoff
- Wait a few seconds before re-running bulk operations
- For heavy usage, deploy a private Koios instance and pass `--koios-base-url`

### Error: "Transaction not confirmed after 200 seconds"

**Cause:** Network congestion or mempool delay.

**Solution:**
- Transaction is likely still valid
- Check explorer manually: https://preprod.cardanoscan.io
- Wait a few more minutes
- Testnet can be slower than mainnet

### Error: "Metadata size exceeds 16 KB limit"

**Cause:** DID document too large for inline storage.

**Solution:**
Use external storage (IPFS):
```python
# In deploy_testnet.py, change storage_format
tx_result = builder.build_enrollment_transaction(
    did_document=did_document,
    utxos=utxos,
    storage_format="external",  # Use IPFS CID instead
    helper_data_cid="QmYourIPFSHash",
    recipient_address=address,
)
```

### Error: "PyCardano type error"

**Cause:** Type mismatch in PyCardano API.

**Solution:**
- Ensure pycardano==0.11.0 installed
- Check Python version (3.9+ required)
- Update dependencies: `pip install -U pycardano`

## Cost Analysis

### Transaction Fees

**Formula:**
```
fee = 155,381 + (44 √ó transaction_size)
```

**Typical Costs:**

| Enrollment Type | TX Size | Fee (lovelace) | Fee (ADA) | USD @ $0.40 |
|----------------|---------|----------------|-----------|-------------|
| 1-finger       | ~700 B  | ~186,000       | 0.186     | $0.074      |
| 4-finger       | ~1000 B | ~199,000       | 0.199     | $0.080      |
| 10-finger      | ~2000 B | ~243,000       | 0.243     | $0.097      |

**Fee Breakdown:**
- Base fee: 155,381 lovelace (0.155 ADA)
- Per-byte fee: 44 lovelace/byte
- Metadata overhead: ~400-800 bytes
- Witness overhead: ~200 bytes

### Network Costs

| Network | Purpose | Cost | Speed |
|---------|---------|------|-------|
| Testnet | Testing | FREE | 20s (1 block) |
| Mainnet | Production | 0.17-0.25 ADA | 20s (1 block) |

**Mainnet Estimates:**
- Single enrollment: ~$0.08 USD
- 1000 enrollments: ~$80 USD
- 100k enrollments: ~$8,000 USD

**Cost Optimization:**
- Use external storage (IPFS) for large DIDs
- Batch multiple enrollments if possible
- Minimize metadata size

## Open-Source Compliance

All components are open-source and free:

### Dependencies

| Component | License | Status | Notes |
|-----------|---------|--------|-------|
| pycardano | Apache 2.0 | ‚úÖ Open | Transaction builder |
| cbor2 | MIT | ‚úÖ Open | CBOR encoding |
| httpx | BSD-3 | ‚úÖ Open | HTTP client |
| cryptography | Apache 2.0 | ‚úÖ Open | Ed25519 keys |

### Services

| Service | License | Free Tier | Self-Hostable |
|---------|---------|-----------|---------------|
| Koios REST API | Apache 2.0 | Public endpoint | ‚úÖ Yes |
| Cardano Node | Apache 2.0 | N/A | ‚úÖ Yes |
| Cardano Explorer | Apache 2.0 | Unlimited | ‚úÖ Yes |

**No Paid Services Required!**

### Alternative Backends

Instead of the public Koios endpoint, you can self-host:

1. **Cardano Node + DB Sync**
   - Run your own full node
   - Query blockchain directly
   - No API limits
   - Requires ~100 GB storage

2. **Ogmios**
   - Lightweight WebSocket API
   - Lower resource requirements
   - Open-source (MPL-2.0)

3. **Kupo**
   - UTXO indexer
   - Faster queries
   - Open-source (MPL-2.0)

## Advanced Usage

### Custom DID Document

Modify `create_sample_did_document()` in script:

```python
def create_custom_did_document(did_id: str, fingers: int) -> Dict[str, Any]:
    """Create custom DID with specified fingerprints."""
    verification_methods = []

    for i in range(fingers):
        verification_methods.append({
            "id": f"{did_id}#fingerprint-{i}",
            "type": "BiometricVerificationMethod2024",
            "controller": did_id,
            "biometricType": "fingerprint",
            # ... customize fields
        })

    return {
        "@context": [...],
        "id": did_id,
        "verificationMethod": verification_methods,
        # ...
    }
```

### External Storage (IPFS)

For large DIDs, use IPFS:

```python
# Upload helper data to IPFS first
helper_data_cid = upload_to_ipfs(helper_data)

# Build transaction with external reference
tx_result = builder.build_enrollment_transaction(
    did_document=did_document,
    utxos=utxos,
    storage_format="external",
    helper_data_cid=helper_data_cid,
    recipient_address=address,
)
```

### Mainnet Deployment

**‚ö†Ô∏è WARNING: Mainnet uses real ADA with monetary value!**

To deploy to mainnet:

```python
# Change network to MAINNET
builder = CardanoTransactionBuilder(
    network=Network.MAINNET,
    signing_key=mainnet_signing_key,
    dry_run=False
)

import os

from decentralized_did.cardano.koios_client import KoiosClient

# Use mainnet Koios API
client = KoiosClient(
   base_url=os.environ.get("KOIOS_BASE_URL", "https://api.koios.rest/api/v1"),
   metadata_scan_limit=2_000,
)
```

**Mainnet Checklist:**
- ‚úÖ Test thoroughly on testnet first
- ‚úÖ Use secure key management (hardware wallet)
- ‚úÖ Start with small amounts
- ‚úÖ Verify all addresses carefully
- ‚úÖ Double-check transaction before signing
- ‚úÖ Keep backup of signing keys (encrypted)

## Next Steps

After successful testnet deployment:

1. **Phase 4 Task 3:** Wallet integration
   - CIP-30 wallet connector
   - Mesh.js for demo wallet
   - Browser-based signing

2. **Phase 4 Task 4:** Advanced features
   - Multi-signature support
   - Threshold authentication
   - Key rotation

3. **Production Deployment:**
   - Mainnet deployment
   - Production key management
   - Monitoring and logging

## Resources

### Documentation
- [PyCardano Docs](https://pycardano.readthedocs.io/)
- [Koios API](https://www.koios.rest/#/)
- [CIP-20 Metadata](https://cips.cardano.org/cips/cip20/)
- [Cardano Docs](https://docs.cardano.org/)

### Explorers
- [Preprod Testnet](https://preprod.cardanoscan.io/)
- [Mainnet](https://cardanoscan.io/)

### Tools
- [Cardano CLI](https://github.com/IntersectMBO/cardano-cli)
- [Cardano Node](https://github.com/IntersectMBO/cardano-node)
- [Koios Status](https://status.koios.rest/)

### Community
- [Cardano Forum](https://forum.cardano.org/)
- [Cardano Stack Exchange](https://cardano.stackexchange.com/)
- [PyCardano GitHub](https://github.com/Python-Cardano/pycardano)

---

**Questions or Issues?**

Open an issue on GitHub: https://github.com/FractionEstate/decentralized-did/issues
