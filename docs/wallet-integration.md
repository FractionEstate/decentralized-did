# Wallet Integration Guide

This guide demonstrates how Cardano wallet providers can integrate the biometric DID metadata produced by this toolkit with minimal effort.

## 1. Generate Metadata Bundles

Use the CLI or Python API to produce a `WalletMetadataBundle`, which encapsulates all formats a wallet might need.

### CLI

```bash
python -m decentralized_did.cli generate \
  --input examples/sample_fingerprints.json \
  --output metadata.json \
  --helpers-output helpers.json \
  --format cip30
```

- `--format wallet` (default) writes a `{label: payload}` mapping ready for direct inclusion in transaction metadata JSON files.
- `--format cip30` writes a helper structure tailored for [CIP-30](https://cips.cardano.org/cips/cip30/) wallet APIs, keeping the DID alongside the metadata tuple list.

### Demo Kit Fast-Path

For demos or user-testing sessions, the CLI can emit a complete bundle of inline/external variants, helper data, and a summary sheet in a single command:

```bash
python -m decentralized_did.cli demo-kit \
  --input examples/sample_fingerprints.json \
  --wallet addr_test1demo123 \
  --output-dir demo-kit \
  --zip demo-kit.zip
```

- Produces `metadata_*` files for both `wallet` and `cip30` formats with inline and external helper modes.
- Writes `helpers.json` so wallets or backend services can stage the external helper payloads.
- Generates `demo_summary.txt` and `demo_summary.json` capturing the DID, helper URI, and wallet address for presenters and automation.
- Emits `cip30_payload.ts` with ready-to-import constants (`biometricDid`, `cip30MetadataEntries`, `cip30MetadataMap`, `helperData`).
- Provides `cip30_demo.ts` showcasing a minimal `attachBiometricMetadata` helper built atop the payload exports.
- Optionally zips the artifacts when `--zip` is supplied, simplifying hand-offs to demo operators.
- Provide `--helper-uri` to point wallets at a real storage location once the helpers are hosted.

### Python Library

```python
from pathlib import Path
from decentralized_did.cardano.wallet_integration import build_wallet_metadata_bundle

bundle = build_wallet_metadata_bundle(
    wallet_address="addr1...",
    digest=master_digest,
    helper_map=helper_map,  # or None when supplying helpers externally
)

bundle.write_json(Path("metadata.json"), fmt="cip30")
print(bundle.did)
```

## 2. Feed Metadata Into CIP-30 Wallet APIs

For CIP-30 compatible wallets, convert the stored metadata list into a `Map<bigint, Metadatum>` before calling `wallet.experimental().submitTx()` or equivalent.

```ts
import metadataJson from "./metadata.json" assert { type: "json" };

const entries = metadataJson.metadata as [number, unknown][];
const metadataMap = new Map(entries.map(([label, payload]) => [BigInt(label), payload]));

// Example with lace/eternl style helpers
await wallet.experimental().tx.send({
  metadata: metadataMap,
  // ...additional transaction fields...
});
```

Wallets that operate directly on JSON can instead use the default `wallet` format, which already returns `{ "1990": { ...payload... } }` with the default metadata label.

## 3. Helper Data Handling

- Inline mode (`--exclude-helpers` omitted) embeds helper data inside the metadata payload. Wallets store and forward a single JSON file.
- External mode (`--exclude-helpers` + `--helpers-output helpers.json` + optional `--helper-uri`) keeps helper data separately. The generated DID metadata contains the URI so the wallet can retrieve the helpers when required.

## 4. Verification Flow

Wallets can reuse the CLI to verify a new biometric scan against stored metadata:

```bash
python -m decentralized_did.cli verify \
  --metadata metadata.json \
  --input examples/sample_fingerprints.json \
  --helpers helpers.json  # only required when helperStorage is external
```

Behind the scenes the CLI recognises both `wallet` and `cip30` metadata files, so the same assets used for submission can be fed back into verification.

## 5. Demo Wallet Implementation Checklist

The repository includes `demo-wallet/`, a copy of the Cardano Foundation's Veridian wallet with Git history stripped. Use it as the reference environment while we upstream the biometric flow.

1. **Install dependencies**
  ```bash
  cd demo-wallet
  npm install
  ```
  The project ships with Webpack + Capacitor tooling. Run `npm run dev` for a browser build or `npm run build:local` for production-equivalent assets.

2. **Expose a biometric metadata channel**
  - Add an experimental API handler (see `src/core/cardano/walletConnect/peerConnection.ts`) that accepts the CIP-30 bundle generated by the Python CLI.
  - Store the parsed bundle via `peerConnectionMetadataStorage` so follow-up sessions can reuse `helperUri` / inline helpers.
  - Emit a `BiometricMetadataUpdated` UI event so the signing screen can request end-user consent before attaching the metadata.

3. **Render approval + persistence UI**
  - Extend the incoming request screen to show the DID, helper storage mode, and any external URI the wallet will record.
  - Require explicit approval before calling `signTx`/`submitTx`, mirroring the existing signature consent flow.

4. **Attach metadata during transaction build**
  - When approval is granted, convert the stored bundle into the CIP-30 tuple form and merge it into the transaction metadata map prior to submission.
  - Provide clear errors if helper data is missing (e.g., user declined but metadata marked `inline`).

5. **Automate the round-trip**
  - Add Jest/unit coverage alongside `identityWalletConnect.test.ts` to exercise the parsing logic.
  - Capture at least one WebDriverIO or integration test that drives the UI with a bundle produced by `examples/sample_fingerprints.json`.

> Track progress against this checklist in `docs/roadmap.md`. When a step lands, update both the roadmap and this guide to reflect the new baseline.
